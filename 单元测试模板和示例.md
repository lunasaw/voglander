# Voglander 单元测试模板和示例

## 1. Manager层单元测试模板

### 基础模板结构
```java
package io.github.lunasaw.voglander.manager.manager;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyList;
import static org.mockito.Mockito.*;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import io.github.lunasaw.voglander.config.TestConfig;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.cache.Cache;
import org.springframework.cache.CacheManager;
import org.springframework.test.context.TestPropertySource;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;

import lombok.extern.slf4j.Slf4j;

/**
 * XXXManager单元测试类
 * 
 * @author luna
 * @date 2025/07/19
 */
@Slf4j
@SpringBootTest(classes = TestConfig.class)
@TestPropertySource(properties = {"spring.cache.type=simple"})
public class XXXManagerTest {

    private final String TEST_XXX_ID = "TEST_XXX_001";
    private final Long TEST_ID = 1L;
    
    @Autowired
    private XXXManager xxxManager;
    
    @Autowired
    private CacheManager cacheManager;
    
    @MockBean
    private XXXService xxxService;
    
    @MockBean
    private XXXAssembler xxxAssembler;
    
    @MockBean
    private RedisCache redisCache;
    
    private XXXDTO testXXXDTO;
    private XXXDO testXXXDO;

    @BeforeEach
    public void setUp() {
        testXXXDTO = createTestXXXDTO();
        testXXXDO = createTestXXXDO();
    }

    // 创建测试数据方法
    private XXXDTO createTestXXXDTO() {
        XXXDTO dto = new XXXDTO();
        dto.setId(TEST_ID);
        dto.setCreateTime(LocalDateTime.now());
        dto.setUpdateTime(LocalDateTime.now());
        // 设置其他字段...
        return dto;
    }

    private XXXDO createTestXXXDO() {
        XXXDO xxxDO = new XXXDO();
        xxxDO.setId(TEST_ID);
        xxxDO.setCreateTime(LocalDateTime.now());
        xxxDO.setUpdateTime(LocalDateTime.now());
        // 设置其他字段...
        return xxxDO;
    }

    // CRUD操作测试
    @Test
    public void testCreateXXX_Success() {
        // Given
        when(xxxAssembler.toXXXDO(testXXXDTO)).thenReturn(testXXXDO);
        when(xxxService.save(any(XXXDO.class))).thenReturn(true);

        // When
        Long result = xxxManager.createXXX(testXXXDTO);

        // Then
        assertNotNull(result);
        verify(xxxService).save(any(XXXDO.class));
        log.info("testCreateXXX_Success passed");
    }

    @Test
    public void testUpdateXXX_Success() {
        // Given
        when(xxxService.getById(TEST_ID)).thenReturn(testXXXDO);
        when(xxxAssembler.toXXXDO(testXXXDTO)).thenReturn(testXXXDO);
        when(xxxService.updateById(any(XXXDO.class))).thenReturn(true);

        // When
        Long result = xxxManager.updateXXX(testXXXDTO);

        // Then
        assertNotNull(result);
        verify(xxxService).updateById(any(XXXDO.class));
        log.info("testUpdateXXX_Success passed");
    }

    @Test
    public void testDeleteXXX_Success() {
        // Given
        when(xxxService.removeById(TEST_ID)).thenReturn(true);

        // When
        Boolean result = xxxManager.deleteXXX(TEST_ID);

        // Then
        assertTrue(result);
        verify(xxxService).removeById(TEST_ID);
        log.info("testDeleteXXX_Success passed");
    }

    @Test
    public void testGetXXXById_Success() {
        // Given
        when(xxxService.getById(TEST_ID)).thenReturn(testXXXDO);
        when(xxxAssembler.toXXXDTO(testXXXDO)).thenReturn(testXXXDTO);

        // When
        XXXDTO result = xxxManager.getXXXById(TEST_ID);

        // Then
        assertNotNull(result);
        assertEquals(TEST_ID, result.getId());
        log.info("testGetXXXById_Success passed");
    }

    // 分页查询测试
    @Test
    public void testPageQuery_Success() {
        // Given
        int page = 1, size = 10;
        Page<XXXDO> mockPage = new Page<>(page, size);
        mockPage.setRecords(Arrays.asList(testXXXDO));
        mockPage.setTotal(1L);

        when(xxxService.page(any(Page.class), any(QueryWrapper.class))).thenReturn(mockPage);
        when(xxxAssembler.toXXXDTOList(anyList())).thenReturn(Arrays.asList(testXXXDTO));

        // When
        Page<XXXDTO> result = xxxManager.pageQuery(page, size, new QueryWrapper<>());

        // Then
        assertNotNull(result);
        assertEquals(1, result.getRecords().size());
        assertEquals(1L, result.getTotal());
        log.info("testPageQuery_Success passed");
    }

    // 参数验证测试
    @Test
    public void testCreateXXX_NullDTO() {
        // When & Then
        assertThrows(IllegalArgumentException.class, () -> {
            xxxManager.createXXX(null);
        });
        log.info("testCreateXXX_NullDTO passed");
    }

    // 缓存测试
    @Test
    public void testCacheableAnnotation() {
        // Given
        Cache xxxCache = cacheManager.getCache("xxx");
        assertNotNull(xxxCache);
        xxxCache.clear();

        when(xxxService.getById(TEST_ID)).thenReturn(testXXXDO);
        when(xxxAssembler.toXXXDTO(testXXXDO)).thenReturn(testXXXDTO);

        // When - 第一次调用
        XXXDTO result1 = xxxManager.getXXXById(TEST_ID);
        
        // Then - 验证缓存
        assertNotNull(result1);
        Cache.ValueWrapper cachedValue = xxxCache.get(TEST_ID);
        assertNotNull(cachedValue);

        // When - 第二次调用
        XXXDTO result2 = xxxManager.getXXXById(TEST_ID);
        
        // Then - 验证使用缓存
        assertEquals(result1.getId(), result2.getId());
        verify(xxxService, times(1)).getById(TEST_ID);
        log.info("testCacheableAnnotation passed");
    }
}
```

## 2. Service层单元测试模板

```java
package io.github.lunasaw.voglander.manager.service.impl;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;

import io.github.lunasaw.voglander.config.TestConfig;
import io.github.lunasaw.voglander.repository.entity.XXXDO;
import io.github.lunasaw.voglander.repository.mapper.XXXMapper;
import lombok.extern.slf4j.Slf4j;

/**
 * XXXServiceImpl单元测试类
 * 
 * @author luna
 * @date 2025/07/19
 */
@Slf4j
@SpringBootTest(classes = TestConfig.class)
public class XXXServiceImplTest {

    @Autowired
    private XXXServiceImpl xxxService;
    
    @MockBean
    private XXXMapper xxxMapper;
    
    private XXXDO testXXXDO;

    @BeforeEach
    public void setUp() {
        testXXXDO = new XXXDO();
        testXXXDO.setId(1L);
        testXXXDO.setCreateTime(LocalDateTime.now());
        testXXXDO.setUpdateTime(LocalDateTime.now());
    }

    @Test
    public void testSave_Success() {
        // Given
        when(xxxMapper.insert(any(XXXDO.class))).thenReturn(1);

        // When
        boolean result = xxxService.save(testXXXDO);

        // Then
        assertTrue(result);
        verify(xxxMapper).insert(testXXXDO);
        log.info("testSave_Success passed");
    }

    @Test
    public void testGetById_Success() {
        // Given
        when(xxxMapper.selectById(1L)).thenReturn(testXXXDO);

        // When
        XXXDO result = xxxService.getById(1L);

        // Then
        assertNotNull(result);
        assertEquals(1L, result.getId());
        verify(xxxMapper).selectById(1L);
        log.info("testGetById_Success passed");
    }

    @Test
    public void testUpdateById_Success() {
        // Given
        when(xxxMapper.updateById(any(XXXDO.class))).thenReturn(1);

        // When
        boolean result = xxxService.updateById(testXXXDO);

        // Then
        assertTrue(result);
        verify(xxxMapper).updateById(testXXXDO);
        log.info("testUpdateById_Success passed");
    }

    @Test
    public void testRemoveById_Success() {
        // Given
        when(xxxMapper.deleteById(1L)).thenReturn(1);

        // When
        boolean result = xxxService.removeById(1L);

        // Then
        assertTrue(result);
        verify(xxxMapper).deleteById(1L);
        log.info("testRemoveById_Success passed");
    }

    @Test
    public void testList_Success() {
        // Given
        List<XXXDO> mockList = Arrays.asList(testXXXDO);
        when(xxxMapper.selectList(any(QueryWrapper.class))).thenReturn(mockList);

        // When
        List<XXXDO> result = xxxService.list(new QueryWrapper<>());

        // Then
        assertNotNull(result);
        assertEquals(1, result.size());
        verify(xxxMapper).selectList(any(QueryWrapper.class));
        log.info("testList_Success passed");
    }
}
```

## 3. DeviceChannelManager 测试用例示例

```java
package io.github.lunasaw.voglander.manager.manager;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

import io.github.lunasaw.voglander.config.TestConfig;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.TestPropertySource;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;

import io.github.lunasaw.voglander.manager.assembler.DeviceAssembler;
import io.github.lunasaw.voglander.manager.domaon.dto.DeviceChannelDTO;
import io.github.lunasaw.voglander.manager.service.DeviceChannelService;
import io.github.lunasaw.voglander.repository.entity.DeviceChannelDO;
import lombok.extern.slf4j.Slf4j;

/**
 * DeviceChannelManager单元测试类
 * 
 * @author luna
 * @date 2025/07/19
 */
@Slf4j
@SpringBootTest(classes = TestConfig.class)
@TestPropertySource(properties = {"spring.cache.type=simple"})
public class DeviceChannelManagerTest {

    private final String TEST_CHANNEL_ID = "34020000001320000001";
    private final Long TEST_ID = 1L;
    
    @Autowired
    private DeviceChannelManager deviceChannelManager;
    
    @MockBean
    private DeviceChannelService deviceChannelService;
    
    @MockBean
    private DeviceAssembler deviceAssembler;
    
    private DeviceChannelDTO testChannelDTO;
    private DeviceChannelDO testChannelDO;

    @BeforeEach
    public void setUp() {
        testChannelDTO = createTestChannelDTO();
        testChannelDO = createTestChannelDO();
    }

    private DeviceChannelDTO createTestChannelDTO() {
        DeviceChannelDTO dto = new DeviceChannelDTO();
        dto.setId(TEST_ID);
        dto.setChannelId(TEST_CHANNEL_ID);
        dto.setDeviceId("34020000001320000000");
        dto.setName("测试通道");
        dto.setStatus(1);
        dto.setCreateTime(LocalDateTime.now());
        dto.setUpdateTime(LocalDateTime.now());
        return dto;
    }

    private DeviceChannelDO createTestChannelDO() {
        DeviceChannelDO channelDO = new DeviceChannelDO();
        channelDO.setId(TEST_ID);
        channelDO.setChannelId(TEST_CHANNEL_ID);
        channelDO.setDeviceId("34020000001320000000");
        channelDO.setName("测试通道");
        channelDO.setStatus(1);
        channelDO.setCreateTime(LocalDateTime.now());
        channelDO.setUpdateTime(LocalDateTime.now());
        return channelDO;
    }

    @Test
    public void testCreateChannel_Success() {
        // Given
        when(deviceAssembler.toDeviceChannelDO(testChannelDTO)).thenReturn(testChannelDO);
        when(deviceChannelService.save(any(DeviceChannelDO.class))).thenReturn(true);

        // When
        Long result = deviceChannelManager.createChannel(testChannelDTO);

        // Then
        assertNotNull(result);
        verify(deviceChannelService).save(any(DeviceChannelDO.class));
        log.info("testCreateChannel_Success passed");
    }

    @Test
    public void testGetChannelByChannelId_Success() {
        // Given
        when(deviceChannelService.getOne(any(QueryWrapper.class))).thenReturn(testChannelDO);
        when(deviceAssembler.toDeviceChannelDTO(testChannelDO)).thenReturn(testChannelDTO);

        // When
        DeviceChannelDTO result = deviceChannelManager.getChannelByChannelId(TEST_CHANNEL_ID);

        // Then
        assertNotNull(result);
        assertEquals(TEST_CHANNEL_ID, result.getChannelId());
        log.info("testGetChannelByChannelId_Success passed");
    }

    @Test
    public void testUpdateChannelStatus_Success() {
        // Given
        when(deviceChannelService.getOne(any(QueryWrapper.class))).thenReturn(testChannelDO);
        when(deviceChannelService.updateById(any(DeviceChannelDO.class))).thenReturn(true);

        // When
        deviceChannelManager.updateChannelStatus(TEST_CHANNEL_ID, 0);

        // Then
        verify(deviceChannelService).updateById(any(DeviceChannelDO.class));
        log.info("testUpdateChannelStatus_Success passed");
    }

    @Test
    public void testBatchCreateChannels_Success() {
        // Given
        List<DeviceChannelDTO> channelList = Arrays.asList(testChannelDTO);
        when(deviceAssembler.toDeviceChannelDO(any(DeviceChannelDTO.class))).thenReturn(testChannelDO);
        when(deviceChannelService.save(any(DeviceChannelDO.class))).thenReturn(true);

        // When
        int result = deviceChannelManager.batchCreateChannels(channelList);

        // Then
        assertEquals(1, result);
        verify(deviceChannelService).save(any(DeviceChannelDO.class));
        log.info("testBatchCreateChannels_Success passed");
    }

    @Test
    public void testCreateChannel_NullDTO() {
        // When & Then
        assertThrows(IllegalArgumentException.class, () -> {
            deviceChannelManager.createChannel(null);
        });
        log.info("testCreateChannel_NullDTO passed");
    }
}
```

## 4. 测试规范说明

### 测试命名规范
- 测试类：`XxxTest` 或 `XxxManagerTest`
- 测试方法：`testMethodName_Scenario`

### 测试结构规范
- **Given**: 设置测试前置条件和Mock数据
- **When**: 执行被测试的方法
- **Then**: 验证结果和Mock调用

### 必须覆盖的测试场景
1. **正常场景**: 成功路径测试
2. **异常场景**: 参数校验、业务异常
3. **边界场景**: 空值、空列表等
4. **缓存场景**: 缓存命中、失效测试

### Mock策略
- 使用 `@MockBean` Mock Spring管理的Bean
- 使用 `@MockitoBean` Mock 普通对象
- Manager层测试Mock Service和Assembler
- Service层测试Mock Mapper

### 断言策略
- 使用 JUnit 5 的 `Assertions` 类
- 验证返回值的正确性
- 验证Mock方法的调用次数和参数
- 验证异常抛出

## 5. 运行测试命令

```bash
# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=DeviceChannelManagerTest

# 运行特定测试方法  
mvn test -Dtest=DeviceChannelManagerTest#testCreateChannel_Success

# 运行集成测试（需要启动Redis）
./start-redis-for-test.sh
mvn test -Dtest=MediaNodeCacheIntegrationTest
```

这份测试模板覆盖了项目中所有核心组件的测试模式，遵循项目的编码规范和架构设计。